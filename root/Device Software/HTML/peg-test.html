<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" >
<html>
	<head>
		<title>Peg Test</title>
		<link rel="stylesheet" type="text/css" href="_style.css" />	
		
		<script language="javascript" src="constants.js"></script>
		<script language="javascript">

		// TODO: make constants for all tests in contants.js
	
		var the_script_frame = parent.frames["scriptframe"];
		the_script_frame.currentTest = "PEG";
		
		var Kinetics = the_script_frame.Kinetics;
		var debounce = false;
		var timerID;
		var the_side_active = "right";
		
		function init()
		{
			if ( the_script_frame.pegDirection == "" || the_script_frame.pegDirection == "left")
			{
				the_script_frame.pegDirection = "left";
				readyRight();
			}
			else
			{
				the_script_frame.pegDirection = "right";
				readyLeft();
			}
			Kinetics.SetLedState(4,0);
			Kinetics.SetLedState(5,0);
			Kinetics.SetLedState(6,0);
		}
		
		// make sure all 8 pegs are on the right
		function checkPegsRight()
		{
			bRet = true;

			for (i=9; i<17; i++)
			{
				if (!the_script_frame.pegIsIn(i))
				{
					bRet = false;
					break;
				}
			}

			return bRet;
		}

		// make sure all 8 pegs are on the left
		function checkPegsLeft()
		{
			bRet = true;

			for (i=1; i<9; i++)
			{
				if (!the_script_frame.pegIsIn(i))
				{
					bRet = false;
					break;
				}
			}

			return bRet;
		}		
		
		// prepare for right hand
		function readyRight()
		{
			the_script_frame.pegDirection = "left";

			if (the_script_frame.pegCountRight > 3)
			{
				Kinetics.ActivityEndNormal();	
				endTest();
			} 
			else if (checkPegsRight())
			{
				header.innerText = "Peg Test - Round " + the_script_frame.pegCountRight + " of 3";
				panel.style.paddingTop = 0;
				panel.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;Right Hand<br>&nbsp;&nbsp;&nbsp;&nbsp;Get Ready";
				
				Kinetics.ActivityEndNormal();		
				Kinetics.ActivityConfig(6, "PEGBOARD", 0, 0);
				the_script_frame.KineticsAudioPlay(
					"\\hard disk\\audio\\begin_at_beep_get_ready.wav");
				
				setTimeout('startRight()',WAIT_GET_READY_DELAY);
			}
			else
			{
				location = "\peg-nopegs-right.html";
			}
		}

		// prepare for left hand
		function readyLeft()
		{
			the_script_frame.pegDirection = "right";
			
			if (the_script_frame.pegCountLeft > 3)
			{
				Kinetics.ActivityEndNormal();	
				endTest();
			}
			else if (checkPegsLeft())
			{
				header.innerText = "Peg Test - Round " + the_script_frame.pegCountLeft + " of 3";
				panel.style.paddingTop = 0;
				panel.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Left Hand<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get Ready";
		
				Kinetics.ActivityEndNormal();
				Kinetics.ActivityConfig(6, "PEGBOARD", 0, 0);
				the_script_frame.KineticsAudioPlay(
					"\\hard disk\\audio\\begin_at_beep_get_ready.wav");
		
				setTimeout('startLeft()',WAIT_GET_READY_DELAY);
			}
			else
			{
				location = "\peg-nopegs-left.html";
			}
		}
				
		// begin test with right hand
		function startRight()
		{	
			if (checkPegsRight())
			{
				the_script_frame.is_pegs_filled = false;
				debugright.innerText = "right: " + the_script_frame.pegCountRight;
				panel.style.paddingTop = "12";
				panel.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style='font-size:28px;color:green;'>GO</font>";
				setTimeout("panel.style.paddingTop=0;panel.innerHTML = 'Right Hand<br>Test In Progress';",2000);

				Kinetics.ActivityStart(1);

				the_side_active = "right";
				resetViewActivityTimer();
			}
			else
			{
				location = "\peg-nopegs-right.html";
			}
		}
		
		// begin test with left hand
		function startLeft()
		{
			if (checkPegsLeft())
			{
				the_script_frame.is_pegs_filled = false;
				debugleft.innerText = "left: " + the_script_frame.pegCountLeft;
				panel.style.paddingTop = "12";
				panel.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style='font-size:28px;color:green;'>GO</font>";
				setTimeout("panel.style.paddingTop=0;panel.innerHTML = 'Left Hand<br>Test In Progress';",2000);

				Kinetics.ActivityStart(1);
				the_side_active = "left";
				resetViewActivityTimer();
			}
			else
			{
				location = "\peg-nopegs-left.html";
			}
		}
		
		// after three rounds
		function endTest()
		{
			header.innerText = "Peg Test - Complete";
			panel.style.paddingTop = 0;
			panel.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Peg Test<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Complete";
			the_script_frame.currentTest = "";

			the_script_frame.pegCountRight = 1;	// used to keep track of round of right hand peg activity
			the_script_frame.pegCountLeft = 1;	// used to keep track of round of left hand peg activity

			setTimeout("location='tap-intro.html';",3000);
		}
		
		// fired from the script frame once all pegs are on left (overrides local javascript timers)
		function allPegsMoved(side)
		{
			if (debounce != true)
			{	
				// clear the 40 second timeout if they get the pegs over sooner
				clearTimeout(timerID);
				
				if (side == "right")
				{
					endOfRight();
				}
				else
				{
					endOfLeft();
				}
				
				// turn on the debounce flag for 1.5 seconds
				debounce = true;
				setTimeout('clearDebounce()',1500);
			}
			else
			{
				the_script_frame.trace("Ignored peg event");
			}
		}
		
		function endOfHalfRound()
		{
			panel.style.paddingTop = "12";
			panel.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style='font-size:28px;color:maroon;'>STOP</font>";
			the_script_frame.KineticsAudioPlay("\\hard disk\\audio\\stop.wav");
		}
		function endOfRight()
		{
			endOfHalfRound();
			the_script_frame.pegCountRight++;
			setTimeout('readyLeft()',ACTIVITY_SPACING_TIME);
		}
		function endOfLeft()
		{
			endOfHalfRound();
			the_script_frame.pegCountLeft++;
			setTimeout('readyRight()',ACTIVITY_SPACING_TIME);
		}

		function clearDebounce()
		{
			debounce = false;
		}
		
		function keyDownLocal()
		{
			parent.frames["scriptframe"].resetActivityTimer();
			// m key (menu)
			if (event.keyCode == 77)
			{
				parent.frames["scriptframe"].Kinetics.CancelAudioPlay(); 		
				window.location = "debug-menu.html";
			}
		}

		function resetViewActivityTimer()
		{
			clearTimeout(timerID);
			if( "right" == the_side_active )
				timerID = setTimeout('endOfRight()', PEG_TIMEOUT);
			else
				timerID = setTimeout('endOfLeft()', PEG_TIMEOUT);
		}
				
		</script>
				
	</head>
	<body class="hands" onload="init();focus()" onkeydown="keyDownLocal()">
		<div id="device" class="device">
			<img src="images/device-peg.gif">
		</div>
		<div id="header" class="header">
			Peg Test - Round 1 of 3
		</div>
		<div id="bluebg" style="position: absolute; left: 0; top:0;">
			<img src="images/halfblue.gif">
		</div>
		<div id="boundingboxtest" class="boundingboxtest" style="top:85;">
			<table border="0" cellpadding="0" cellspacing="0">
				<tr>
				<td><img src="images/boundingbox-topleft.gif"></td>
				<td width="100" height="14" background="images/boundingbox-top.gif"></td>
				<td><img src="images/boundingbox-topright.gif"></td>
				</tr>
				<tr>
				<td height="60" background="images/boundingbox-left.gif"></td>
				<td background="images/boundingbox-bg.gif"></td>
				<td height="60" background="images/boundingbox-right.gif"></td>
				</tr>
				<tr>
				<td><img src="images/boundingbox-bottomleft.gif"></td>
				<td width="100" height="14" background="images/boundingbox-bottom.gif"></td>
				<td><img src="images/boundingbox-bottomright.gif"></td>
				</tr>
			</table>
		</div>
		<div id="panel" class="inprogress">
			
		</div>
		<div id="debugleft" name="debugleft" style="position:absolute;top:370"></div>
		<div id="debugright" name="debugright" style="position:absolute;top:400"></div>
	</body>
</html>
